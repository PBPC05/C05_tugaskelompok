<!-- Modal -->

<div id="predictionModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
    <div id="modalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
        <!-- Modal header and close button -->
        <div class="flex items-center justify-between p-4 border-b">
            <div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">
                    Make your vote
                </h3>
            </div>
            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">
                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="sr-only">Close modal</span>
            </button>
        </div>

        <div class="px-6 py-4 space-y-6">
            <form id="voteForm" class="flex flex-col gap-5">
                {% csrf_token %}
                <div>
                    <label for="driver-select" class="font-bold text-xl sm:text-2xl mb-2 text-black tracking-tight">Driver</label>
                    <hr class="border-gray-700 mb-2">
                    <select id="driver-select" class="text-lg p-2 min-w-full" required>
                        <option value="">Please select a driver...</option>
                        <optgroup label="Alpine">
                            <option value="Pierre Gasly">Pierre Gasly</option>
                            <option value="Franco Colapinto">Franco Colapinto</option>
                        </optgroup>
                        <optgroup label="Aston Martin">
                            <option value="Fernando Alonso">Fernando Alonso</option>
                            <option value="Lance Stroll">Lance Stroll</option>
                        </optgroup>
                        <optgroup label="Ferrari">
                            <option value="Charles Leclerc">Charles Leclerc</option>
                            <option value="Lewis Hamilton">Lewis Hamilton</option>
                        </optgroup>
                        <optgroup label="Haas">
                            <option value="Esteban Ocon">Esteban Ocon</option>
                            <option value="Oliver Bearman">Oliver Bearman</option>
                        </optgroup>
                        <optgroup label="Kick Sauber">
                            <option value="Gabriel Bortoleto">Gabriel Bortoleto</option>
                            <option value="Nico Hulkenberg">Nico Hulkenberg</option>
                        </optgroup>
                        <optgroup label="McLaren">
                            <option value="Lando Norris">Lando Norris</option>
                            <option value="Oscar Piastri">Oscar Piastri</option>
                        </optgroup>
                        <optgroup label="Mercedes">
                            <option value="Kimi Antonelli">Kimi Antonelli</option>
                            <option value="George Russell">George Russell</option>
                        </optgroup>
                        <optgroup label="Racing Bulls">
                            <option value="Isack Hadjar">Isack Hadjar</option>
                            <option value="Liam Lawson">Liam Lawson</option>
                        </optgroup>
                        <optgroup label="Red Bull">
                            <option value="Max Verstappen">Max Verstappen</option>
                            <option value="Yuki Tsunoda">Yuki Tsunoda</option>
                        </optgroup>
                        <optgroup label="Williams">
                            <option value="Alex Albon">Alex Albon</option>
                            <option value="Carlos Sainz">Carlos Sainz</option>
                        </optgroup>
                    </select>
                </div>

                <div>
                    <label for="team-select" class="font-bold text-xl sm:text-2xl mb-2 text-black tracking-tight">Team</label>
                    <hr class="border-gray-700 mb-2">
                    <select id="team-select" class="text-lg p-2 min-w-full" required>
                        <option value="">Please select a team...</option>
                        <option>Alpine</option>
                        <option>Aston Martin</option>
                        <option>Ferrari</option>
                        <option>Haas</option>
                        <option>Kick Sauber</option>
                        <option>McLaren</option>
                        <option>Mercedes</option>
                        <option>Racing Bulls</option>
                        <option>Red Bull</option>
                        <option>Williams</option>
                    </select>
                </div>
            </form>

            <!-- Modal footer -->
            <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
                <button type="button" id="cancelButton" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center" onclick="hideModal()">Cancel</button>
                <button type="submit" id="submitVote" form="voteForm" class="order-1 sm:order-2 flex-1 bg-red-700 text-white px-6 py-3 rounded-md font-medium hover:bg-red-900 transition-colors">Vote Now</button>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showModal() {
        const modal = document.getElementById('predictionModal');
        const modalContent = document.getElementById('modalContent');
        const form = document.getElementById('voteForm');

        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
        }, 50);
    }

    function hideModal() {
        const modal = document.getElementById('predictionModal');
        const modalContent = document.getElementById('modalContent');
        const form = document.getElementById('voteForm');
        modalContent.classList.remove('opacity-100', 'scale-100');
        modalContent.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 150);
    }

    async function postVote() {
        const driverVote = document.getElementById("driver-select").value;
        const teamVote = document.getElementById("team-select").value;

        const csrftoken = getCookie('csrftoken');

        var driverData = new FormData();
        driverData.append("vote_type", "driver");
        driverData.append("race", "2025 Mexico City Grand Prix");
        driverData.append("content", driverVote);

        var teamData = new FormData();
        teamData.append("vote_type", "team");
        teamData.append("race", "2025 Mexico City Grand Prix");
        teamData.append("content", teamVote);

        await fetch("{% url 'prediction:post_vote' %}", {
            method: "POST",
            body: driverData,
            headers: { "X-CSRFToken": csrftoken },
            mode: 'same-origin',
        });
        await fetch("{% url 'prediction:post_vote' %}", {
            method: "POST",
            body: teamData,
            headers: { "X-CSRFToken": csrftoken },
            mode: 'same-origin',
        });

        document.getElementById("voteForm").reset();
        hideModal();

        // Dispatch custom event to notify main.html about new data
        sessionStorage.setItem('user_has_voted', true);
        document.dispatchEvent(new CustomEvent('votePosted'));

        return false;
    }

    document.getElementById("voteForm").addEventListener("submit", function (e) {
        e.preventDefault();
        postVote();
    })
</script>
{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Team Profile - PitTalk</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-neutral-900 pt-10 text-white min-h-screen">
    
    <!-- Konten Utama --><div class="max-w-6xl mx-auto px-5 md:px-10 pt-10 pb-20">

        <!-- Loading State --><div id="loading" class="text-center py-40">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white/50 mx-auto"></div>
            <p class="mt-6 text-lg text-gray-300">Loading Team Profile...</p>
        </div>

        <!-- Error State --><div id="error" class="hidden bg-neutral-900 border border-red-500/40 p-10 text-center rounded-3xl shadow-lg">
            <div class="text-7xl mb-4">⚠️</div>
            <h3 class="text-2xl font-semibold text-red-300 mb-2">Failed to load team data</h3>
            <p id="error-message-detail" class="text-lg text-gray-400">The requested team could not be found. Please try again later.</p>
        </div>

        <div id="team-detail-container" class="hidden">

            <div id="team-hero-container" class="rounded-3xl border border-white/10 mb-12">
                </div>

            <h2 class="text-3xl font-bold text-white mb-6">Team Stats</h2>
            <div id="team-stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-12">
                </div>

            <h2 class="text-3xl font-bold text-white mb-6">Information</h2>
            <div id="team-bio-list" class="bg-neutral-800 border border-white/10 rounded-3xl p-6 md:p-8">
                </div>

        </div>

    </div>
</div>

<script>
    const teamSlug = "{{ team_slug|default:'default-slug'|safe }}"; 
    const TEAM_API_ENDPOINT = `{% url 'information:show_team_json_detail' 'default-slug' %}`.replace('default-slug', teamSlug);

    // --- DOM Elements---
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const errorMessageDetail = document.getElementById('error-message-detail');
    const container = document.getElementById('team-detail-container');
    const heroContainer = document.getElementById('team-hero-container');
    const statsGrid = document.getElementById('team-stats-grid');
    const bioList = document.getElementById('team-bio-list');

    function getHigherResImageUrl(url, height = 800) {
        if (!url) return '';
        return url.replace(/,(h_\d+|w_\d+)/g, `,h_${height}`);
    }

    function normalizeHexColor(c) {
        if (!c) return '#111827';
        return c.replace(/^##+/, '#');
    }

    function renderHero(item) {
        const teamColor = normalizeHexColor(item.color);
        heroContainer.style.backgroundColor = teamColor;

        const logoImgUrl = getHigherResImageUrl(item.team_logo, 600);

        heroContainer.innerHTML = `
            <div class="relative grid md:grid-cols-2 items-center min-h-[400px]">
                
                <!-- Kiri: Info -->
                <div class="relative z-10 flex flex-col justify-center p-6 md:p-10 h-full min-h-[400px]">
                    <h1 id="hero-full-name" class="text-5xl md:text-7xl font-extrabold text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.3);">
                        ${item.full_name}
                    </h1>
                    <p id="hero-base" class="text-2xl font-semibold text-white/80">${item.base}</p>
                </div>

                <!-- Kanan: Logo -->
                <div class="absolute bottom-0 right-0 w-full h-full md:relative min-h-[400px] overflow-hidden flex items-center justify-center p-10">
                    <!-- Faded di mobile agar teks terbaca -->
                    <img id="hero-team-logo" src="${logoImgUrl}" 
                         alt="${item.name} logo"
                         class="w-full h-auto max-w-md object-contain opacity-20 md:opacity-100">
                </div>
            </div>
        `;
    }

    function createStatCard(label, value) {
        return `
            <div class="bg-neutral-800 border border-white/10 rounded-3xl p-5">
                <p class="text-sm font-medium text-gray-400">${label}</p>
                <p class="text-3xl md:text-4xl font-extrabold text-white mt-1">${value || 'N/A'}</p>
            </div>
        `;
    }

    function createBioItem(label, value) {
        return `
            <div class="py-4 grid grid-cols-3 gap-4 border-b border-white/10">
                <dt class="text-sm font-medium text-gray-400">${label}</dt>
                <dd class="text-sm text-white font-semibold col-span-2">${value || 'N/A'}</dd>
            </div>
        `;
    }

    function renderTeamDetail(item) {
        document.title = `${item.full_name} | 2025 Profile`;

        renderHero(item);

        statsGrid.innerHTML = '';
        statsGrid.innerHTML += createStatCard('World Championships', item.world_championships);
        statsGrid.innerHTML += createStatCard('Pole Positions', item.pole_positions);
        statsGrid.innerHTML += createStatCard('Fastest Laps', item.fastest_laps);
        statsGrid.innerHTML += createStatCard('Highest Race Finish', item.highest_race_finish);

        bioList.innerHTML = '';
        bioList.innerHTML += createBioItem('Team Chief', item.team_chief);
        bioList.innerHTML += createBioItem('Technical Chief', item.technical_chief);
        bioList.innerHTML += createBioItem('Chassis', item.chassis);
        bioList.innerHTML += createBioItem('Power Unit', item.power_unit);
        bioList.innerHTML += createBioItem('First Team Entry', item.first_team_entry);

        loading.classList.add('hidden');
        errorMessage.classList.add('hidden');
        container.classList.remove('hidden');
    }

    async function fetchTeamData() {
        if (teamSlug === 'default-slug') {
            loading.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorMessageDetail.textContent = "No team specified. The URL seems to be missing the team's slug.";
            return;
        }

        try {
            const response = await fetch(TEAM_API_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (!response.ok) {
                if (response.status === 404) {
                    errorMessageDetail.textContent = `Team with slug "${teamSlug}" not found. Check the URL or slug.`;
                }
                throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
            }

            const teamData = await response.json();
            const item = teamData.data ? teamData.data : teamData;
            
            if (item && item.full_name) {
                renderTeamDetail(item);
            } else {
                throw new Error('Invalid data structure received from server');
            }

        } catch (error) {
            console.error('Error loading team data:', error);
            loading.classList.add('hidden');
            errorMessage.classList.remove('hidden');
        }
    }

    fetchTeamData();

</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Teams</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-neutral-900 pt-10 text-white min-h-screen">
    <header id="hero-image-teams">
        <div id="hero-text" class="px-5 py-20 max-w-xl text-white">
            <h1 class="text-5xl font-bold">2025 Teams</h1>
            <h2 class="text-lg font-semibold">Discover the constructors, leadership, and engineering behind each car.</h2>
    </header>

    <div class="px-10 pt-10 pb-20">

        <!-- Search Bar -->
        <div class="mb-10 max-w-lg mx-auto">
            <input type="text" id="search-input" 
                   placeholder="Search by team name..."
                   class="w-full px-5 py-3 bg-neutral-800 border border-white/20 rounded-full text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50">
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden">
            <article class="flex flex-col md:flex-row bg-gray-500 rounded-3xl my-10 overflow-hidden animate-pulse">
                <div class="min-w-full min-h-[180px]"></div>
            </article>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-neutral-900 border border-red-500/40 p-10 text-center rounded-xl shadow-lg">
            <div class="text-6xl mb-4">⚠️</div>
            <h3 class="text-lg font-semibold text-red-300 mb-2">Failed to load teams</h3>
            <p class="text-gray-400">Please try again later.</p>
        </div>

        <!-- Grid Container -->
        <section id="grid" class="hidden grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
            
        </section>
    </div>
</div>

<script>
    const TEAMS_API_ENDPOINT = "{% url 'information:show_teams_json' %}";

    // DOM Elements
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const teamsGridContainer = document.getElementById('grid');
    const searchInput = document.getElementById('search-input');

    // State Variables
    let allTeamsData = [];
    let currentSearchTerm = '';

    function getHigherResImageUrl(url) {
        if (!url) return '';
        return url.replace(/,h_\d+/g, ',h_320').replace(/,w_\d+/g, ',w_320');
    }

    // Show/hide page sections
    function displayPageSection({ showLoading = false, showError = false, showGrid = false }) {
        loading.classList.toggle('hidden', !showLoading);
        errorMessage.classList.toggle('hidden', !showError);
        teamsGridContainer.classList.toggle('hidden', !showGrid);

        if (showGrid) {
            teamsGridContainer.className = 'grid sm:grid-cols-1 lg:grid-cols-2 gap-8'; 
        }
    }

    function normalizeHexColor(c) {
        if (!c) return '#111827';
        return c.replace(/^##+/, '#');
    }

    function buildTeamCardElement(item) {
        const link = document.createElement('a');
        link.href = item.url || '#';
        link.className =
            'relative block overflow-hidden rounded-3xl border border-white/10 ' +
            'hover:scale-[1.02] transition-transform duration-200 ' +
            'min-h-[160px] md:min-h-[180px]';

        link.style.backgroundColor = normalizeHexColor(item.color);

        const wrap = document.createElement('div');
        wrap.className = 'relative z-10 flex items-stretch justify-between h-full p-6 ' +
                         'bg-gradient-to-r from-black/60 via-black/40 to-transparent';
        link.appendChild(wrap);

        const left = document.createElement('div');
        left.className = 'flex-1 flex flex-col justify-center pr-4';
        wrap.appendChild(left);

        const name = document.createElement('h3');
        name.className = 'text-3xl md:text-4xl font-extrabold text-white';
        name.textContent = item.name || 'Unknown Team';
        left.appendChild(name);

        const right = document.createElement('div');
        right.className = 'relative w-24 md:w-32 flex-shrink-0 flex items-center justify-center';
        wrap.appendChild(right);

        if (item.team_logo) {
            const logoImg = document.createElement('img');
            logoImg.src = getHigherResImageUrl(item.team_logo);
            logoImg.alt = `${item.name} logo`;
            logoImg.className = 'w-full h-auto object-contain max-h-[100px]'; 
            right.appendChild(logoImg);
        }

        return link;
    }

    function renderAllTeamsCards(teamsItems) {
        teamsGridContainer.innerHTML = '';
        teamsItems.forEach(teamItem => {
            const cardElement = buildTeamCardElement(teamItem);
            teamsGridContainer.appendChild(cardElement);
        });
    }

    function filterAndDisplayTeams() {
        const searchTerm = currentSearchTerm.toLowerCase().trim();
        let teamsToDisplay = [];

        if (searchTerm === '') {
            teamsToDisplay = allTeamsData;
        } else {
            teamsToDisplay = allTeamsData.filter(team => {
                const fullName = (team.full_name || '').toLowerCase();
                const shortName = (team.name || '').toLowerCase();
                return fullName.includes(searchTerm) || shortName.includes(searchTerm);
            });
        }

        renderAllTeamsCards(teamsToDisplay);
        displayPageSection({ showGrid: true });
    }

    async function fetchTeamsFromServer() {
        try {
            displayPageSection({ showLoading: true });

            const response = await fetch(TEAMS_API_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (!response.ok) {
                throw new Error('Failed to fetch data from server');
            }

            const teamsData = await response.json();
            allTeamsData = teamsData || [];

            filterAndDisplayTeams();
        } catch (error) {
            console.error('Error loading teams:', error);
            displayPageSection({ showError: true });
        }
    }

    function initializeTeamsPage() {
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            filterAndDisplayTeams();
        });

        fetchTeamsFromServer();
    }

    initializeTeamsPage();
</script>
{% endblock %}


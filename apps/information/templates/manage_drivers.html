{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Manage Drivers - Admin</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen bg-[#15151e] pt-20 pb-10 text-gray-200">
  <div class="container mx-auto px-4 max-w-7xl">

    <div class="bg-gradient-to-r from-[#e10600] to-[#ff1e00] rounded-xl shadow-2xl p-6 mb-6">
      <h1 class="text-3xl font-bold text-white mb-2">Manage Drivers</h1>
      <p class="text-red-100">Edit driver statistics and information.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <a href="{% url 'authentication:manage_users' %}" class="bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white rounded-lg shadow-lg p-4 transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-90">User</p>
            <p class="text-xl font-bold">Management</p>
          </div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </div>
      </a>

      <a href="{% url 'information:manage_driver' %}" class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-4 ring-2 ring-offset-2 ring-offset-[#15151e] ring-green-400 cursor-default">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-90">Driver</p>
            <p class="text-xl font-bold">Management</p>
          </div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
      </a>

      <a href="{% url 'information:manage_teams' %}" class="bg-gradient-to-br from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 text-white rounded-lg shadow-lg p-4 transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-90">Team</p>
            <p class="text-xl font-bold">Management</p>
          </div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
      </a>

      <a href="{% url 'information:manage_results' %}" class="bg-gradient-to-br from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-white rounded-lg shadow-lg p-4 transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-90">Race</p>
            <p class="text-xl font-bold">Results</p>
          </div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
          </svg>
        </div>
      </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-[#1e1e2c] rounded-lg shadow-xl p-6 border-l-4 border-green-500">
        <div class="flex items-center">
          <div class="flex-shrink-0">
             <svg class="h-10 w-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
             </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-400">Total Drivers</p>
            <p class="text-2xl font-bold text-white">{{ total_drivers }}</p>
          </div>
        </div>
      </div>
    </div>


    <div class="bg-[#1e1e2c] rounded-lg shadow-xl overflow-hidden">

       <div class="px-6 py-4 border-b border-gray-700">
        <h2 class="text-xl font-bold text-white">Driver List</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700">
          <thead class="bg-[#15151e]">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Team</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Number</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Podiums</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Points</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Entries</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Champs</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="driver-table-body" class="bg-[#1e1e2c] divide-y divide-gray-700">
            {% for driver in drivers %}
            <tr id="driver-row-{{ driver.pk }}" class="hover:bg-[#252537] transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="ml-4">
                    <div class="text-sm font-medium text-white">{{ driver.full_name }}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{{ driver.team.name|default:"N/A" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-300 font-semibold">{{ driver.number }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-300 data-podiums">{{ driver.podiums|default:"0" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-300 data-points">{{ driver.points|default:"0" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-300 data-entries">{{ driver.grands_prix_entered|default:"0" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-300 data-champs">{{ driver.world_championships|default:"0" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button
                   class="edit-driver-btn inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-500 transition-colors"
                   data-driver-pk="{{ driver.pk }}"
                   data-driver-name="{{ driver.full_name }}"
                   data-podiums="{{ driver.podiums|default:'0' }}"
                   data-points="{{ driver.points|default:'0.0' }}"
                   data-entries="{{ driver.grands_prix_entered|default:'0' }}"
                   data-champs="{{ driver.world_championships|default:'0' }}"
                   data-highest-race="{{ driver.highest_race_finish|default:'' }}"
                   data-highest-grid="{{ driver.highest_grid_position|default:'' }}"
                   >
                  Edit
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="px-6 py-10 text-center text-gray-500">No drivers found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
     <div class="mt-6">
        <a href="{% url 'authentication:manage_users' %}" class="inline-flex items-center px-4 py-2 border border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-300 bg-[#1e1e2c] hover:bg-[#252537] transition-colors">
            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Back to Admin Dashboard
        </a>
    </div>
  </div>
</div>

<div id="editDriverModal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-black bg-opacity-75 transition-opacity duration-300 ease-out" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
      <div class="absolute inset-0 bg-gray-900 opacity-75"></div>
    </div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-[#1e1e2c] rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-gray-700">
      <form id="editDriverForm" method="post">
          {% csrf_token %}
          <input type="hidden" name="driver_pk" id="modal_driver_pk">
          <div class="bg-[#1e1e2c] px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
              <div class="sm:flex sm:items-start">
                  <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                      <h3 class="text-lg leading-6 font-medium text-white mb-4" id="modal-title">
                          Edit Driver: <span id="modal_driver_name" class="font-bold"></span>
                      </h3>
                      <div id="modal_error_messages" class="text-red-400 text-sm mb-4 hidden"></div>
                      <div class="mt-2 space-y-4">
                          {% for field in edit_form %}
                          <div>
                              <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-300">{{ field.label }}</label>
                              <div class="mt-1">
                                  {{ field }} {# This renders the input with id="id_..." #}
                                  <div id="error_{{ field.name }}" class="text-red-400 text-xs mt-1">
                                      {% if field.errors %}{{ field.errors|striptags }}{% endif %}
                                  </div>
                              </div>
                          </div>
                          {% endfor %}
                      </div>
                  </div>
              </div>
          </div>
          <div class="bg-[#15151e] px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
              <button type="submit" id="saveDriverBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm transition-colors">
                  Save Changes
              </button>
              <button type="button" id="cancelModalBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-[#252537] text-base font-medium text-gray-300 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition-colors">
                  Cancel
              </button>
          </div>
      </form>
    </div>
  </div>
</div>

<div id="toastContainer" class="fixed top-20 right-4 z-[9999] space-y-2"></div>


<script>
    const modal = document.getElementById('editDriverModal');
    const modalForm = document.getElementById('editDriverForm');
    const driverTableBody = document.getElementById('driver-table-body');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const modalDriverPkInput = document.getElementById('modal_driver_pk');
    const modalDriverNameSpan = document.getElementById('modal_driver_name');
    const modalErrorMessagesDiv = document.getElementById('modal_error_messages');
    const toastContainer = document.getElementById('toastContainer');


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    driverTableBody.addEventListener('click', (event) => {
        const target = event.target.closest('.edit-driver-btn');
        if (target) {
            const pk = target.dataset.driverPk;
            const name = target.dataset.driverName;

            modalDriverPkInput.value = pk;
            modalDriverNameSpan.textContent = name;

            try {
                const fieldsToPopulate = [
                    { id: 'id_podiums', datasetKey: 'podiums' },
                    { id: 'id_points', datasetKey: 'points' },
                    { id: 'id_grands_prix_entered', datasetKey: 'entries' },
                    { id: 'id_world_championships', datasetKey: 'champs' },
                    { id: 'id_highest_race_finish', datasetKey: 'highestRace' },
                    { id: 'id_highest_grid_position', datasetKey: 'highestGrid' }
                ];

                let allFieldsFound = true;

                for (const field of fieldsToPopulate) {
                    const element = document.getElementById(field.id);
                    if (!element) {
                        console.error(`Error populating form: Element with ID '${field.id}' not found in the modal.`);
                        allFieldsFound = false;
                    } else {
                        element.value = target.dataset[field.datasetKey];
                    }
                }

                if (!allFieldsFound) {
                    alert("Error preparing edit form: One or more form fields could not be found. Check console for details.");
                    return;
                }

            } catch (e) {
                console.error("Unexpected error populating form field:", e);
                alert("An unexpected error occurred while preparing the edit form. Check console.");
                return;
            }

            clearModalErrors();
            modal.classList.remove('hidden');
        }
    });

    function closeModal() {
        modal.classList.add('hidden');
        modalForm.reset();
        clearModalErrors();
    }
    cancelModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    function clearModalErrors() {
        modalErrorMessagesDiv.classList.add('hidden');
        modalErrorMessagesDiv.innerHTML = '';
        const errorSpans = modalForm.querySelectorAll('[id^="error_"]');
        errorSpans.forEach(span => span.textContent = '');
    }

    function showToast(message, type = 'success') {
        const toastId = `toast-${Date.now()}`;
        const toastElement = document.createElement('div');
        toastElement.id = toastId;

        let toastClass = 'toast-info';
        let iconSvg = `
            <svg class="toast-icon h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
            </svg>`;

        if (type === 'success') {
            toastClass = 'toast-success';
            iconSvg = `
            <svg class="toast-icon h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>`;
        } else if (type === 'error') {
            toastClass = 'toast-error';
             iconSvg = `
            <svg class="toast-icon h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>`;
        } else if (type === 'warning') {
            toastClass = 'toast-warning';
             iconSvg = `
            <svg class="toast-icon h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>`;
        }

        toastElement.className = `toast-notification ${toastClass}`;

        const closeButtonSvg = `
            <svg class="h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>`;

        toastElement.innerHTML = `
            ${iconSvg}
            <p class="toast-message">${message}</p>
            <button class="toast-close">
               ${closeButtonSvg}
            </button>
        `;

        toastContainer.appendChild(toastElement);

        requestAnimationFrame(() => {
             requestAnimationFrame(() => {
                 toastElement.classList.add('show');
             });
        });

        const closeButton = toastElement.querySelector('.toast-close');
        closeButton.addEventListener('click', () => {
            toastElement.classList.remove('show');
            toastElement.addEventListener('transitionend', () => {
                if (toastElement.parentNode) {
                     toastElement.parentNode.removeChild(toastElement);
                }
            }, { once: true });
        });

        setTimeout(() => {
            if (toastElement.parentNode) {
                 closeButton.click();
            }
        }, 5000);
    }


    modalForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        clearModalErrors();

        const driverPk = modalDriverPkInput.value;
        const urlTemplate = "{% url 'information:driver_update_ajax' 0 %}";
        const updateUrl = urlTemplate.replace('0', driverPk);


        const formData = new FormData(modalForm);

        const saveButton = document.getElementById('saveDriverBtn');
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';


        try {
            const response = await fetch(updateUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            });

            const contentType = response.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) {
                 data = await response.json();
            } else {
                const textResponse = await response.text();
                console.error("Received non-JSON response:", textResponse);
                throw new Error(`Server returned status ${response.status} but not JSON. Check network tab.`);
            }


            if (response.ok && data.ok) {
                const driverRow = document.getElementById(`driver-row-${driverPk}`);
                if (driverRow) {
                    driverRow.querySelector('.data-podiums').textContent = formData.get('podiums') || '0';
                    driverRow.querySelector('.data-points').textContent = formData.get('points') || '0.0';
                    driverRow.querySelector('.data-entries').textContent = formData.get('grands_prix_entered') || '0';
                    driverRow.querySelector('.data-champs').textContent = formData.get('world_championships') || '0';

                    const editButton = driverRow.querySelector('.edit-driver-btn');
                    if(editButton) {
                        editButton.dataset.podiums = formData.get('podiums') || '0';
                        editButton.dataset.points = formData.get('points') || '0.0';
                        editButton.dataset.entries = formData.get('grands_prix_entered') || '0';
                        editButton.dataset.champs = formData.get('world_championships') || '0';
                        editButton.dataset.highestRace = formData.get('highest_race_finish') || '';
                        editButton.dataset.highestGrid = formData.get('highest_grid_position') || '';
                    }
                }
                closeModal();
                showToast("Driver updated successfully!", 'success');

            } else {
                if (data.errors) {
                    modalErrorMessagesDiv.classList.remove('hidden');
                    let generalErrors = [];
                    for (const fieldName in data.errors) {
                        const errorElement = document.getElementById(`error_${fieldName}`);
                        if (errorElement) {
                            errorElement.textContent = data.errors[fieldName].join(' ');
                        } else {
                            generalErrors = generalErrors.concat(data.errors[fieldName]);
                        }
                    }
                     if (generalErrors.length > 0) {
                        modalErrorMessagesDiv.innerHTML = `<strong>Errors:</strong><br>${generalErrors.join('<br>')}`;
                    } else {
                         modalErrorMessagesDiv.innerHTML = `<strong>Please correct the errors below.</strong>`;
                    }
                } else {
                     modalErrorMessagesDiv.classList.remove('hidden');
                     modalErrorMessagesDiv.innerHTML = `<strong>An unexpected error occurred.</strong><br>${data.message || `Server responded with status ${response.status}.`}`;
                }
                showToast("Failed to update driver. Please check errors.", 'error');
            }

        } catch (error) {
            console.error('AJAX Error:', error);
            modalErrorMessagesDiv.classList.remove('hidden');
            modalErrorMessagesDiv.innerHTML = `<strong>Error:</strong> ${error.message}. Please check console and network tab for details.`;
            showToast("Network or server error occurred. Please try again.", 'error');

        } finally {
             saveButton.disabled = false;
             saveButton.textContent = 'Save Changes';
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const formInputsModal = modalForm.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select, textarea');
        formInputsModal.forEach(input => {
             if (!input.classList.contains('bg-gray-700')) {
                 input.classList.add('bg-gray-700', 'border', 'border-gray-600', 'text-white', 'text-sm', 'rounded-lg', 'focus:ring-blue-500', 'focus:border-blue-500', 'block', 'w-full', 'p-2.5');
             }
        });
    });

</script>

{% endblock content %}


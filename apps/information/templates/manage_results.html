{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Manage Race Results - Admin</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen bg-[#15151e] pt-20 pb-10 text-gray-200">
  <div class="container mx-auto px-4 max-w-7xl">
    <div class="bg-gradient-to-r from-[#e10600] to-[#ff1e00] rounded-xl shadow-2xl p-6 mb-6">
      <h1 class="text-3xl font-bold text-white mb-2">Manage Race Results</h1>
      <p class="text-red-100">Append or delete driver results for each race.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <a href="{% url 'authentication:manage_users' %}" class="bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white rounded-lg shadow-lg p-4 transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div><p class="text-sm opacity-90">User</p><p class="text-xl font-bold">Management</p></div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        </div>
      </a>
      <a href="{% url 'information:manage_driver' %}" class="bg-gradient-to-br from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white rounded-lg shadow-lg p-4 transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div><p class="text-sm opacity-90">Driver</p><p class="text-xl font-bold">Management</p></div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </div>
      </a>
      <a href="{% url 'information:manage_teams' %}" class="bg-gradient-to-br from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 text-white rounded-lg shadow-lg p-4 transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div><p class="text-sm opacity-90">Team</p><p class="text-xl font-bold">Management</p></div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
        </div>
      </a>
      <a href="{% url 'information:manage_results' %}" class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg shadow-lg p-4 ring-2 ring-offset-2 ring-offset-[#15151e] ring-yellow-400 cursor-default">
        <div class="flex items-center justify-between">
          <div><p class="text-sm opacity-90">Race</p><p class="text-xl font-bold">Results</p></div>
          <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg>
        </div>
      </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-[#1e1e2c] rounded-lg shadow-xl p-6 border-l-4 border-yellow-500">
        <div class="flex items-center">
          <div class="flex-shrink-0">
             <svg class="h-10 w-10 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-400">Total Results Recorded</p>
            <p class="text-2xl font-bold text-white">{{ total_results }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-[#1e1e2c] rounded-lg shadow-xl p-6 mb-8 border border-gray-700">
        <h2 class="text-xl font-bold text-white mb-4">Append New Race Result</h2>
        <form id="appendResultForm" method="post">
            {% csrf_token %}
            <div id="append_form_error_messages" class="text-red-400 text-sm mb-4 hidden"></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% for field in append_form %}
                <div>
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-1">{{ field.label }}</label>
                    {{ field }}
                     <div id="append_error_{{ field.name }}" class="text-red-400 text-xs mt-1"></div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-6 text-right">
                <button type="submit" id="appendResultBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    Add Result
                </button>
            </div>
        </form>
    </div>

    <div class="bg-[#1e1e2c] rounded-lg shadow-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-700">
        <h2 class="text-xl font-bold text-white">Existing Race Results</h2>
      </div>
      <div id="results-list-container">
        {% for race in races_data %}
        <div class="border-b border-gray-700 last:border-b-0 race-section" data-race-id="{{ race.pk }}"> {# Added data-race-id #}
            <div class="bg-[#15151e] px-6 py-3">
                <h3 class="text-lg font-semibold text-white">{{ race.name }} ({{ race.date|date:"Y-m-d" }})</h3>
                <p class="text-sm text-gray-400">{{ race.circuit.name }} - Round {{ race.round_number }}</p>
            </div>
            <div class="divide-y divide-gray-700 results-for-race-{{ race.pk }}"> {# Added class #}
                {% for result in race.results_list %}
                <div id="result-row-{{ result.pk }}" class="px-6 py-3 grid grid-cols-12 gap-4 items-center hover:bg-[#252537]">
                    {# Menggunakan result.cell_display untuk menampilkan Posisi atau Status #}
                    <div class="col-span-1 text-center font-semibold {% if not result.finish_position %}text-red-400{% endif %}">{{ result.cell_display }}</div>
                    <div class="col-span-3">
                        <span class="font-medium text-white">{{ result.driver.full_name }}</span>
                        <span class="text-xs text-gray-400"> #{{ result.driver.number }}</span>
                    </div>
                    <div class="col-span-3 text-sm text-gray-400">{{ result.team.name }}</div>
                    <div class="col-span-2 text-sm text-center text-gray-300">{{ result.time_text|default:"N/A" }}</div>
                    <div class="col-span-1 text-sm text-center font-bold text-gray-300">{{ result.points_awarded|default:"0" }} pts</div>
                    <div class="col-span-1 text-center">
                         {% if result.fastest_lap %}
                         <svg class="w-5 h-5 text-purple-400 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                         {% endif %}
                    </div>
                    <div class="col-span-1 text-right">
                        <button
                            class="delete-result-btn text-red-500 hover:text-red-400 text-xs font-medium"
                            data-result-pk="{{ result.pk }}"
                            data-result-info="{{ race.name }} - {{ result.driver.full_name }} (Pos: {{ result.cell_display }})">
                            Delete
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="px-6 py-4 text-center text-gray-500 text-sm italic no-results-message">No results recorded for this race yet.</div> {# Added class #}
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="px-6 py-10 text-center text-gray-500">No races found.</div>
        {% endfor %}
      </div>
    </div>

     <div class="mt-6">
        <a href="{% url 'authentication:manage_users' %}" class="inline-flex items-center px-4 py-2 border border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-300 bg-[#1e1e2c] hover:bg-[#252537] transition-colors">
            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            Back to Admin Dashboard
        </a>
    </div>
  </div>
</div>

<div id="toastContainer" class="fixed top-20 right-4 z-[9999] space-y-2"></div>

<script>
    const appendForm = document.getElementById('appendResultForm');
    const resultsListContainer = document.getElementById('results-list-container');
    const toastContainer = document.getElementById('toastContainer');
    const appendFormErrorMessagesDiv = document.getElementById('append_form_error_messages');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value; // Get token if available

    function showToast(message, type = 'success') {
        if (!toastContainer) {
            console.error("Toast container '#toastContainer' not found!");
            return;
        }

        const toastId = `toast-${Date.now()}`;
        const toastElement = document.createElement('div');
        toastElement.id = toastId;

        let toastClass = 'toast-info';
        let iconSvg = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>`; // Info Icon

        if (type === 'success') {
            toastClass = 'toast-success';
            iconSvg = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`; // Success Icon
        } else if (type === 'error') {
            toastClass = 'toast-error';
             iconSvg = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>`; // Error Icon
        } else if (type === 'warning') {
            toastClass = 'toast-warning';
             iconSvg = `<svg class="toast-icon h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`; // Warning Icon
        }

        toastElement.className = `toast-notification ${toastClass}`;

        const closeButtonSvg = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>`;

        toastElement.innerHTML = `
            ${iconSvg}
            <p class="toast-message">${message}</p>
            <button class="toast-close">
               ${closeButtonSvg}
            </button>
        `;

        toastContainer.appendChild(toastElement);

        requestAnimationFrame(() => {
             requestAnimationFrame(() => {
                 toastElement.classList.add('show');
             });
        });

        const closeButton = toastElement.querySelector('.toast-close');
        closeButton.addEventListener('click', () => {
            toastElement.classList.remove('show');
            toastElement.addEventListener('transitionend', () => {
                if (toastElement.parentNode === toastContainer) {
                     toastContainer.removeChild(toastElement);
                }
            }, { once: true });
        });

        setTimeout(() => {
            if (toastElement.parentNode === toastContainer) {
                 closeButton.click();
            }
        }, 5000);
    }


    function clearAppendFormErrors() {
        if (appendFormErrorMessagesDiv) {
            appendFormErrorMessagesDiv.classList.add('hidden');
            appendFormErrorMessagesDiv.innerHTML = '';
        }
        const errorSpans = appendForm.querySelectorAll('[id^="append_error_"]');
        errorSpans.forEach(span => span.textContent = '');
    }

    appendForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        clearAppendFormErrors();

        const appendUrl = "{% url 'information:raceresult_append_ajax' %}";
        const formData = new FormData(appendForm);
        const appendButton = document.getElementById('appendResultBtn');
        appendButton.disabled = true;
        appendButton.textContent = 'Adding...';

        try {
            const response = await fetch(appendUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            });

            const contentType = response.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) {
                data = await response.json();
            } else {
                const textResponse = await response.text();
                console.error("Received non-JSON response:", textResponse);
                throw new Error(`Server returned status ${response.status} but not JSON.`);
            }

            if (response.ok && data.ok) {
                showToast("Race result appended successfully!", 'success');
                appendForm.reset();

            } else {
                if (data.errors) {
                    appendFormErrorMessagesDiv.classList.remove('hidden');
                    let generalErrors = [];
                    for (const fieldName in data.errors) {
                        const errorElement = document.getElementById(`append_error_${fieldName}`);
                        if (errorElement) {
                            errorElement.textContent = data.errors[fieldName].join(' ');
                        } else {
                            generalErrors = generalErrors.concat(data.errors[fieldName]);
                        }
                    }
                    if (generalErrors.length > 0) {
                        appendFormErrorMessagesDiv.innerHTML = `<strong>Errors:</strong><br>${generalErrors.join('<br>')}`;
                    } else {
                        appendFormErrorMessagesDiv.innerHTML = `<strong>Please correct the errors below.</strong>`;
                    }
                } else {
                    appendFormErrorMessagesDiv.classList.remove('hidden');
                    appendFormErrorMessagesDiv.innerHTML = `<strong>Error:</strong> ${data.message || `Server responded with status ${response.status}.`}`;
                }
                 showToast("Failed to append result. Please check errors.", 'error');
            }

        } catch (error) {
            console.error('Append AJAX Error:', error);
            appendFormErrorMessagesDiv.classList.remove('hidden');
            appendFormErrorMessagesDiv.innerHTML = `<strong>Network/Server Error:</strong> ${error.message}.`;
            showToast("Network or server error occurred.", 'error');
        } finally {
            appendButton.disabled = false;
            appendButton.textContent = 'Add Result';
        }
    });

    resultsListContainer.addEventListener('click', async (event) => {
        const target = event.target.closest('.delete-result-btn');
        if (target) {
            const resultPk = target.dataset.resultPk;
            const resultInfo = target.dataset.resultInfo || "this result";

            if (confirm(`Are you sure you want to delete ${resultInfo}? This action cannot be undone.`)) {
                const deleteUrlTemplate = "{% url 'information:raceresult_delete_ajax' 0 %}";
                const deleteUrl = deleteUrlTemplate.replace('0', resultPk);

                target.disabled = true;
                target.textContent = 'Deleting...';

                try {
                    const response = await fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    });

                    const contentType = response.headers.get("content-type");
                    let data;
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        data = await response.json();
                    } else {
                        const textResponse = await response.text();
                        console.error("Received non-JSON response:", textResponse);
                         throw new Error(`Server returned status ${response.status} but not JSON.`);
                    }

                    if (response.ok && data.ok) {
                        const rowToRemove = document.getElementById(`result-row-${resultPk}`);
                        if (rowToRemove) {
                            rowToRemove.style.transition = 'opacity 0.3s ease-out';
                            rowToRemove.style.opacity = '0';
                            setTimeout(() => {
                                rowToRemove.remove();
                                const raceSection = target.closest('.race-section');
                                if (raceSection) {
                                    const resultsDiv = raceSection.querySelector(`.results-for-race-${raceSection.dataset.raceId}`);
                                    const remainingResults = resultsDiv?.querySelectorAll('[id^="result-row-"]');
                                    if (resultsDiv && remainingResults && remainingResults.length === 0) {
                                        if (!resultsDiv.querySelector('.no-results-message')) {
                                             resultsDiv.innerHTML = '<div class="px-6 py-4 text-center text-gray-500 text-sm italic no-results-message">No results recorded for this race yet.</div>';
                                        }
                                    }
                                }
                            }, 300);
                        }
                        showToast("Race result deleted successfully!", 'success');

                    } else {
                         showToast(`Failed to delete result: ${data.message || 'Server error'}`, 'error');
                         target.disabled = false;
                         target.textContent = 'Delete';
                    }
                } catch (error) {
                    console.error('Delete AJAX Error:', error);
                    showToast(`Network/Server Error: ${error.message}`, 'error');
                    target.disabled = false;
                    target.textContent = 'Delete';
                }
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (!appendForm) return;
        const formInputsAppend = appendForm.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select, textarea, input[type="checkbox"]');
        formInputsAppend.forEach(input => {
            if(input.type === 'checkbox') {
                 input.classList.add('h-4', 'w-4', 'rounded', 'border-gray-600', 'bg-gray-700', 'text-blue-600', 'focus:ring-blue-500');
            } else if (!input.classList.contains('bg-gray-700')) {
                 input.classList.add('bg-gray-700', 'border', 'border-gray-600', 'text-white', 'text-sm', 'rounded-lg', 'focus:ring-blue-500', 'focus:border-blue-500', 'block', 'w-full', 'p-2.5');
            }
        });
    });
</script>

{% endblock content %}


{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Driver Profile</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-neutral-900 pt-10 text-white min-h-screen">
    
    <!-- Konten Utama --><div class="max-w-6xl mx-auto px-5 md:px-10 pt-10 pb-20">

        <!-- Loading State --><div id="loading" class="text-center py-40">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white/50 mx-auto"></div>
            <p class="mt-6 text-lg text-gray-300">Loading Driver Profile...</p>
        </div>

        <!-- Error State --><div id="error" class="hidden bg-neutral-900 border border-red-500/40 p-10 text-center rounded-3xl shadow-lg">
            <div class="text-7xl mb-4">⚠️</div>
            <h3 class="text-2xl font-semibold text-red-300 mb-2">Failed to load driver data</h3>
            <p id="error-message-detail" class="text-lg text-gray-400">The requested driver could not be found. Please try again later.</p>
        </div>

        <div id="driver-detail-container" class="hidden">

            <div id="driver-hero-container" class="rounded-3xl border border-white/10 mb-12">
                </div>

            <h2 class="text-3xl font-bold text-white mb-6">Career Stats</h2>
            <div id="driver-stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-12">
                </div>

            <h2 class="text-3xl font-bold text-white mb-6">Biography</h2>
            <div id="driver-bio-list" class="bg-neutral-800 border border-white/10 rounded-3xl p-6 md:p-8">
                </div>

        </div>

    </div>
</div>

<script>
    const driverSlug = "{{ driver_slug|default:'default-slug'|safe }}"; 
    const DRIVER_API_ENDPOINT = `{% url 'information:show_driver_json_detail' 'default-slug' %}`.replace('default-slug', driverSlug);

    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const errorMessageDetail = document.getElementById('error-message-detail');
    const container = document.getElementById('driver-detail-container');
    const heroContainer = document.getElementById('driver-hero-container');
    const statsGrid = document.getElementById('driver-stats-grid');
    const bioList = document.getElementById('driver-bio-list');

    function getHigherResImageUrl(url, height = 800) {
        if (!url) return '';
        return url.replace(/,(h_\d+|w_\d+)/g, `,h_${height}`);
    }

    function normalizeHexColor(c) {
        if (!c) return '#111827';
        return c.replace(/^##+/, '#');
    }

    function renderHero(item) {
        const teamColor = normalizeHexColor(item.color);
        heroContainer.style.backgroundColor = teamColor;

        const driverImgUrl = getHigherResImageUrl(item.driver_image, 1600);
        const numberImgUrl = getHigherResImageUrl(item.number_image, 600);

        heroContainer.innerHTML = `
            <div class="relative grid md:grid-cols-2 items-end min-h-[450px]">
                
                <div class="relative z-10 flex flex-col justify-between p-6 md:p-10 h-full min-h-[450px]">
                    <div>
                        <h1 id="hero-full-name" class="text-5xl md:text-7xl font-extrabold text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.3);">
                            ${item.full_name}
                        </h1>
                        <p id="hero-team" class="text-2xl font-semibold text-white/80">${item.team}</p>
                    </div>
                    
                    <img id="hero-number-img" src="${numberImgUrl}" 
                         alt="${item.full_name} number" 
                         class="mt-8 w-1/2 max-w-[250px] h-auto object-contain">
                </div>

                <div class="absolute bottom-0 right-0 w-full h-full md:relative min-h-[450px] overflow-hidden">
                    <img id="hero-driver-img" src="${driverImgUrl}" 
                         alt="${item.full_name}"
                         class="absolute right-0 top-0 h-auto w-[115%] max-w-none object-cover object-right">
                </div>
            </div>
        `;
        
        const driverImgEl = document.getElementById('hero-driver-img');
        const numberImgEl = document.getElementById('hero-number-img');
        if (window.innerWidth < 768) {
            driverImgEl.classList.add('opacity-30');
            numberImgEl.classList.add('opacity-80');
        }
    }

    function createStatCard(label, value) {
        return `
            <div class="bg-neutral-800 border border-white/10 rounded-3xl p-5">
                <p class="text-sm font-medium text-gray-400">${label}</p>
                <p class="text-3xl md:text-4xl font-extrabold text-white mt-1">${value || 'N/A'}</p>
            </div>
        `;
    }

    function createBioItem(label, value) {
        return `
            <div class="py-4 grid grid-cols-3 gap-4 border-b border-white/10">
                <dt class="text-sm font-medium text-gray-400">${label}</dt>
                <dd class="text-sm text-white font-semibold col-span-2">${value || 'N/A'}</dd>
            </div>
        `;
    }

    function renderDriverDetail(item) {
        document.title = `${item.full_name} | 2025 Profile`;
        renderHero(item);

        statsGrid.innerHTML = '';
        statsGrid.innerHTML += createStatCard('World Championships', item.world_championships);
        statsGrid.innerHTML += createStatCard('Podiums', item.podiums);
        statsGrid.innerHTML += createStatCard('Career Points', item.points);
        statsGrid.innerHTML += createStatCard('Grands Prix Entered', item.grands_prix_entered);

        bioList.innerHTML = '';
        bioList.innerHTML += createBioItem('Country', item.country);
        bioList.innerHTML += createBioItem('Date of Birth', item.date_of_birth);
        bioList.innerHTML += createBioItem('Place of Birth', item.place_of_birth);
        bioList.innerHTML += createBioItem('Highest Race Finish', item.highest_race_finish);
        bioList.innerHTML += createBioItem('Highest Grid Position', item.highest_grid_position);

        loading.classList.add('hidden');
        errorMessage.classList.add('hidden');
        container.classList.remove('hidden');
    }

    async function fetchDriverData() {
        if (driverSlug === 'default-slug') {
            loading.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorMessageDetail.textContent = "No driver specified. The URL seems to be missing the driver's slug.";
            return;
        }

        try {
            const response = await fetch(DRIVER_API_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (!response.ok) {
                if (response.status === 404) {
                    errorMessageDetail.textContent = `Driver with slug "${driverSlug}" not found. Check the URL or slug.`;
                }
                throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
            }

            const driverData = await response.json();
            const item = driverData.data ? driverData.data : driverData;
            
            if (item && item.full_name) {
                renderDriverDetail(item);
            } else {
                throw new Error('Invalid data structure received from server');
            }

        } catch (error) {
            console.error('Error loading driver data:', error);
            loading.classList.add('hidden');
            errorMessage.classList.remove('hidden');
        }
    }

    fetchDriverData();

</script>
{% endblock %}


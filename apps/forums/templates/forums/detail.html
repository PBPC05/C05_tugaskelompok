{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>{{ forum.title }} - PitTalk Forums</title>
{% endblock meta %}

{% block content %}
<div class="bg-neutral-950 min-h-screen py-20 px-4">
  <div class="max-w-3xl mx-auto bg-neutral-900 rounded-2xl shadow-lg border border-neutral-800 p-6">

    <!-- Forum Header -->
    <header class="mb-6 break-words">
      <a href="{% url 'forums:list' %}" 
         class="inline-flex items-center gap-2 text-sm text-gray-300 hover:text-red-400 transition mb-4">
        ‚Üê Back to Forums
      </a>
      <h1 class="text-3xl font-bold mb-2 text-white break-words">{{ forum.title }}</h1>
      <div class="text-gray-400 text-sm flex flex-wrap gap-2">
        <span>by 
          {% if forum.user %}
            <a href="{% url 'authentication:view_profile' forum.user.username %}"
               class="text-gray-200 font-medium hover:text-red-400 transition">
               {{ forum.user.username }}
            </a>
          {% else %}<i>Anonymous</i>{% endif %}
        </span>
        ‚Ä¢ {{ forum.created_at|naturaltime }}
        ‚Ä¢ {{ forum.forums_views }} views
        ‚Ä¢ <span id="like-count">{{ forum.forums_likes.count }}</span> likes
      </div>
    </header>

    <!-- Forum Content -->
    <article class="prose prose-invert mb-8 leading-relaxed text-gray-200 break-words">
      {{ forum.content|linebreaks }}
    </article>

    <!-- Action Buttons -->
    <div class="flex flex-wrap items-center gap-3 mb-8">
      {% if request.user.is_authenticated %}
        <button id="like-btn" 
            class="px-4 text-gray-200 py-2 bg-red-600 hover:bg-red-700 transition rounded-lg text-sm font-medium">
            {% if user_has_liked %}üëé Unlike{% else %}üëç Like{% endif %}
        </button>

        {% if request.user == forum.user %}
          <a href="{% url 'forums:edit_forum' forum.forums_id %}" 
             class="px-4 text-gray-200 py-2 bg-orange-700 hover:bg-orange-600 rounded-lg text-sm">Edit</a>
            {% csrf_token %}
            <button type="submit" class="inline-block px-4 py-2 bg-red-800 hover:bg-red-900 rounded-lg text-sm text-gray-200" 
                    onclick="openDeleteModal()">Delete</button>
          </form>
        {% endif %}
      {% else %}
        <a href="{% url 'authentication:login' %}?next={% url 'forums:show_forum_detail' forum.forums_id %}"
           class="px-4 py-2 bg-red-600 hover:bg-red-700 text-gray-200 rounded-lg text-sm">Login to interact</a>
      {% endif %}
    </div>

    <hr class="border-gray-700 mb-6">

    <!-- Replies Section -->
    <section id="replies">
      <h2 class="text-xl font-semibold mb-4 text-white">Replies (<span id="replies-count">{{ forum.forums_replies_counts }}</span>)</h2>

      <!-- Reply Form -->
      {% if request.user.is_authenticated %}
      <form id="reply-form" class="mb-6">
        {% csrf_token %}
        <textarea name="replies_content" rows="4" 
                  class="w-full p-3 rounded-lg bg-neutral-800 text-gray-200 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-red-600" 
                  placeholder="Write your reply..."></textarea>
        <div class="mt-3 flex justify-end">
          <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm">Post Reply</button>
        </div>
      </form>
      {% else %}
      <p class="text-gray-400 mb-2 italic">Login to post a reply.</p>
      {% endif %}

      <!-- Replies List -->
      <div id="replies-list" class="space-y-4">
        {% for r in replies %}
          <div class="p-4 bg-neutral-800 border border-neutral-700 rounded-xl flex gap-3 break-words" id="reply-{{ r.id }}">
            {% if r.user %}
            <a href="{% url 'authentication:view_profile' r.user.username %}">
            <div class="w-10 h-10 bg-gray-600 rounded-full flex items-center hover:bg-gray-700 justify-center text-white font-bold cursor-pointer">
              {{ r.user.username|slice:":1"|upper }}
            </div>
            </a>
            {% else %}
            <div class="w-10 h-10 bg-gray-600 rounded-full flex items-center hover:bg-gray-700 justify-center text-white font-bold cursor-pointer">
              A
            </div>
            {% endif %}
            <div class="flex-1">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-semibold text-gray-200 hover:text-gray-300">
                    {% if r.user %}
                    <a href="{% url 'authentication:view_profile' r.user.username %}">{{ r.user.username }}</a>
                    {% else %}Anonymous{% endif %}
                  </div>
                  <div class="text-gray-400 text-xs" data-created-at="{{ r.created_at|date:'c' }}">{{ r.created_at|date:'c' }}</div>
                </div>
                <div class="text-sm flex items-center gap-2 text-gray-200">
                  <span id="reply-like-{{ r.id }}">{{ r.forums_replies_likes.count }}</span> ‚ù§Ô∏è
                  {% if request.user.is_authenticated %}
                    <button data-reply-id="{{ r.id }}" class="reply-like-btn ml-2 px-2 py-1 bg-gray-300 text-black rounded text-xs hover:bg-gray-400 transition">
                      {% if r.user_has_liked %}üëé Unlike{% else %}üëç Like{% endif %}
                    </button>
                    {% if request.user == r.user or request.user == forum.user %}
                      <button data-reply-id="{{ r.id }}" class="reply-delete-btn ml-2 px-2 py-1 bg-red-700 text-white rounded text-xs hover:bg-red-800 transition">
                        Delete
                      </button>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
              <div class="mt-2 text-gray-200">{{ r.replies_content|linebreaks }}</div>
            </div>
          </div>
        {% empty %}
          <p class="text-gray-400 italic no-replies-msg">No replies yet. Be the first to comment!</p>
        {% endfor %}
      </div>

      {% if forum.forums_replies_counts > replies|length %}
        <button id="load-more-btn" class="mt-3 px-4 py-2 text-gray-300 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">Load more</button>
      {% endif %}
    </section>
  </div>
  
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
<div class="bg-neutral-900 p-6 rounded-xl shadow-xl w-80 text-center">
  <h2 class="text-white text-lg mb-4">Confirm Delete?</h2>
  <div class="flex justify-center gap-3">
    <button id="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Delete</button>
    <button id="cancel-delete" class="bg-neutral-700 hover:bg-neutral-600 text-white px-4 py-2 rounded-lg">Cancel</button>
  </div>
</div>
</div>


<div id="delete-modal-forum"
     class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg text-center">
    <h2 class="text-xl font-semibold mb-3">Delete Forum</h2>
    <p class="text-gray-600 mb-5">
      Are you sure you want to delete this forum? This action cannot be undone.
    </p>
    <div class="flex justify-center gap-4">
      <button
        type="button"
        onclick="closeDeleteModal()"
        class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition-all"
      >
        Cancel
      </button>
      <form method="POST" action="{% url 'forums:delete_forum' forum.forums_id %}">
        {% csrf_token %}
        <button
          type="submit"
          class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all"
        >
          Delete
        </button>
      </form>
    </div>
  </div>
</div>



<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
const forumId = "{{ forum.forums_id }}";

const likeBtn = document.getElementById('like-btn');
if (likeBtn) {
  likeBtn.addEventListener('click', async () => {
    const res = await fetch("{% url 'forums:like_forum' forum.forums_id %}", {
      method:'POST',
      headers:{'X-CSRFToken': csrftoken},
    });
    const data = await res.json();
    document.getElementById('like-count').textContent = data.forums_likes;
    likeBtn.textContent = data.user_has_liked ? 'üëé Unlike' : 'üëç Like';
  });
}

let replyToDelete = null;

document.addEventListener('click', async (e) => {

  if(e.target.classList.contains('reply-like-btn')){
    const replyId = e.target.dataset.replyId;
    const span = document.getElementById(`reply-like-${replyId}`);
    const res = await fetch(`/forums/reply/${replyId}/like/`, {
      method:'POST',
      headers:{'X-CSRFToken': csrftoken},
    });
    const data = await res.json();
    span.textContent = data.likes;
    e.target.textContent = data.user_has_liked ? 'üëé Unlike' : 'üëç Like';
  }

  if (e.target.classList.contains('reply-delete-btn')) {
    e.preventDefault();
    replyToDelete = e.target.dataset.replyId;
    document.getElementById('delete-modal').classList.remove('hidden');
  }
});

document.getElementById('cancel-delete').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.add('hidden');
  replyToDelete = null;
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
  if (!replyToDelete) return;

  const res = await fetch(`/forums/reply/${replyToDelete}/delete/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': csrftoken },
  });

  const data = await res.json();
  if (data.deleted) {
    document.getElementById(`reply-${replyToDelete}`).remove();
    const countEl = document.getElementById('replies-count');
    countEl.textContent = parseInt(countEl.textContent) - 1;
  }

  document.getElementById('delete-modal').classList.add('hidden');
  replyToDelete = null;
});

const replyForm = document.getElementById('reply-form');
const repliesList = document.getElementById('replies-list');
const repliesCountEl = document.getElementById('replies-count');
let offset = Number("{{ replies|length|default:0 }}");
const limit = 5;

if(replyForm){
  replyForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const formData = new FormData(replyForm);
    const res = await fetch("{% url 'forums:create_reply' forum.forums_id %}", {
      method:'POST',
      headers:{'X-CSRFToken': csrftoken},
      body: formData
    });
    if (res.ok) {
  const data = await res.json();
  const div = document.createElement('div');
  div.id = `reply-${data.id}`;
  div.className = 'p-4 bg-neutral-800 border border-neutral-700 rounded-xl flex gap-3 break-words';
  div.innerHTML = `
    <div class="w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center text-white font-bold">
      ${data.username.slice(0,1).toUpperCase()}
    </div>
    <div class="flex-1 text-gray-200 ">
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold text-gray-200">${data.username}</div>
          <div class="text-gray-400 text-xs" data-created-at="${data.created_at}">${timeAgo(new Date(data.created_at + 'Z'))}</div>
        </div>
        <div class="text-sm flex items-center gap-2">
          <span id="reply-like-${data.id}">${data.likes}</span> ‚ù§Ô∏è
          <button data-reply-id="${data.id}" 
            class="reply-like-btn ml-2 px-2 py-1 bg-gray-300 text-black rounded text-xs hover:bg-gray-400 transition">
            üëç Like
          </button>
          ${data.is_owner || data.is_forum_owner ? `
            <button data-reply-id="${data.id}" 
              class="reply-delete-btn ml-2 px-2 py-1 bg-red-700 text-white rounded text-xs hover:bg-red-800 transition">
              Delete
            </button>
          ` : ''}
        </div>
      </div>
      <div class="mt-2 text-gray-200">${data.content}</div>
    </div>
  `;
  repliesList.prepend(div);
  repliesCountEl.textContent = parseInt(repliesCountEl.textContent)+1;

  const noRepliesMsg = document.querySelector('.no-replies-msg');
  if (noRepliesMsg) noRepliesMsg.remove();

  replyForm.reset();
}
  });
}

function openDeleteModal() {
    document.getElementById('delete-modal-forum').classList.remove('hidden');
  }

function closeDeleteModal() {
  document.getElementById('delete-modal-forum').classList.add('hidden');
}

const loadMoreBtn = document.getElementById('load-more-btn');
if(loadMoreBtn){
  loadMoreBtn.addEventListener('click', async () => {
    const res = await fetch("{% url 'forums:load_more_replies' forum.forums_id %}", {
      method:'POST',
      headers:{'X-CSRFToken': csrftoken},
      body: new URLSearchParams({'offset': offset,'limit': limit})
    });
    const data = await res.json();
    data.replies.forEach(r => {
      const div = document.createElement('div');
      div.id = `reply-${r.id}`;
      div.className = 'p-4 bg-neutral-800 border border-neutral-700 rounded-xl flex gap-3 break-words';
      div.innerHTML = `
        <div class="w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center text-white font-bold">
          ${r.username.slice(0,1).toUpperCase()}
        </div>
        <div class="flex-1 text-gray-200">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-gray-200">${r.username}</div>
              <div class="text-gray-400 text-xs" data-created-at="${r.created_at}">${timeAgo(new Date(r.created_at + 'Z'))}</div>
            </div>
            <div class="text-sm flex items-center gap-2">
              <span id="reply-like-${r.id}">${r.likes}</span> ‚ù§Ô∏è
              <button data-reply-id="${r.id}" class="reply-like-btn ml-2 px-2 py-1 bg-gray-300 text-black rounded text-xs hover:bg-gray-400 transition">${r.user_has_liked ? 'üëé Unlike' : 'üëç Like'}</button> 
              ${r.is_owner || r.is_forum_owner ? `
            <button data-reply-id="${r.id}" 
              class="reply-delete-btn ml-2 px-2 py-1 bg-red-700 text-white rounded text-xs hover:bg-red-800 transition">
              Delete
            </button>
            ` : ''}
            </div>
          </div>
          <div class="mt-2 text-gray-200">${r.content}</div>
        </div>
      `;
      repliesList.appendChild(div);
    });
    offset += data.replies.length;
    if(data.replies.length < limit) loadMoreBtn.remove();
  });
}

function timeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const intervals = {
    year: 31536000,
    month: 2592000,
    week: 604800,
    day: 86400,
    hour: 3600,
    minute: 60,
  };

  for (const [unit, secondsInUnit] of Object.entries(intervals)) {
    const count = Math.floor(seconds / secondsInUnit);
    if (count >= 1) {
      return `${count} ${unit}${count > 1 ? 's' : ''} ago`;
    }
  }

  return 'just now';
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-created-at]').forEach(el => {
    const dateStr = el.getAttribute('data-created-at');
    if (dateStr) {
      el.textContent = timeAgo(new Date(dateStr));
    }
  });
});
</script>

{% endblock content %}

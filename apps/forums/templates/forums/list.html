{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Forums - PitTalk</title>
{% endblock meta %}

{% block content %}
<div class="bg-neutral-900 pt-10 text-white min-h-screen">
  <header class="px-5 py-5 max-w-xl text-white mt-10">
    <h1 class="text-5xl font-bold">PitTalk Forums</h1>
  </header>

  <div class="p-10">
    <div class="flex gap-4 items-center mb-6">
      <input id="search-input" type="search" placeholder="Search title..." class="p-2 text-black rounded-md w-1/3" />
      <button id="search-btn" class="px-4 py-2 bg-red-700 hover:bg-red-900 rounded-md">Search</button>

      <div class="ml-auto">
        {% if user.is_authenticated %}
        <a href="{% url 'forums:create_forum' %}" class="px-4 py-2 bg-red-600 hover:bg-red-800 rounded-md font-semibold">New Discussion</a>
        {% else %}
        <a href="{% url 'login' %}?next={% url 'forums:create_forum' %}" class="px-4 py-2 bg-red-600 hover:bg-red-800 rounded-md font-semibold">Login to create</a>
        {% endif %}
      </div>
    </div>

    <div id="loading" class="hidden">Loading...</div>
    <div id="error" class="hidden text-red-400">Failed to load forums</div>
    <section id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></section>
    <section id="empty" class="hidden bg-neutral-900 border border-gray-800 rounded-xl p-12 text-center">
      <img src="{% static 'image/not_available.png' %}" alt="" class="w-32 h-32 mx-auto mb-6 opacity-80">
      <h3 class="text-2xl font-bold text-white">No discussion yet</h3>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
<script>
const API = "{% url 'forums:show_json' %}";
const grid = document.getElementById('grid');
const loading = document.getElementById('loading');
const errorEl = document.getElementById('error');
const emptyEl = document.getElementById('empty');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');

function showLoading() {
  loading.classList.remove('hidden');
  errorEl.classList.add('hidden');
  grid.classList.add('hidden');
  emptyEl.classList.add('hidden');
}
function showError() {
  errorEl.classList.remove('hidden');
  loading.classList.add('hidden');
}
function showEmpty() {
  emptyEl.classList.remove('hidden');
  loading.classList.add('hidden');
  grid.classList.add('hidden');
}
function showGrid() {
  grid.classList.remove('hidden');
  loading.classList.add('hidden');
  emptyEl.classList.add('hidden');
}

function buildCard(item) {
  const forum = document.createElement('forum');
  forum.className = 'flex flex-col md:flex-row bg-white hover:bg-gray-100 rounded-sm divide-x-4 overflow-hidden';

  const link = "{% url 'forums:show_forum_detail' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', item.id);

  const title = DOMPurify.sanitize(item.title);
  const content = DOMPurify.sanitize(item.content);

  forum.innerHTML = `
    <div class="max-w-sm aspect-[16/9] overflow-hidden shrink-0 grow-0 p-3">
      <div class="bg-gray-200 text-gray-700 flex items-center justify-center h-full rounded">${content}</div>
    </div>
    <div class="p-5 flex flex-col flex-1">
      <h3 class="text-lg font-semibold text-black mb-2 line-clamp-2">
        <a href="${link}" class="hover:text-red-800">${title}</a>
      </h3>
      <p class="text-sm text-gray-700 mb-3 line-clamp-3">${item.author || 'Anonymous'}</p>
      <div class="flex items-center text-sm text-gray-500">
        <time>${new Date(item.created_at).toLocaleDateString()}</time>
        <span class="mx-2">•</span>
        <span>${item.news_views} views</span>
        <span class="mx-2">•</span>
        <span>${item.news_comments} replies</span>
      </div>
      <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
        <a href="${link}" class="text-red-600 hover:text-red-700 font-medium text-sm">Read more</a>
      </div>
    </div>
  `;
  return forum;
}

async function fetchAndRender(q='') {
  try {
    showLoading();
    const url = new URL(API, window.location.origin);
    if (q) url.searchParams.set('q', q);
    const res = await fetch(url, { headers: {'Accept': 'application/json'} });
    if (!res.ok) throw new Error('fetch failed');
    const data = await res.json();
    grid.innerHTML = '';
    if (data.results.length === 0) {
      showEmpty();
      return;
    }
    data.results.forEach(item => grid.appendChild(buildCard(item)));
    showGrid();
  } catch (e) {
    console.error(e);
    showError();
  }
}

searchBtn.addEventListener('click', () => fetchAndRender(searchInput.value.trim()));
searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') fetchAndRender(searchInput.value.trim()); });

fetchAndRender();
</script>
{% endblock content %}

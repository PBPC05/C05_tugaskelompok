{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>Forums - PitTalk</title>
{% endblock meta %}

{% block content %}
<div class="bg-neutral-900 pt-10 text-white min-h-screen">
  <header id="hero-image-forum">
        <div id="hero-text" class="px-5 py-20 max-w-xl text-white">
            <h1 class="text-5xl font-bold">Forums</h1>
            <h2 class="text-lg font-semibold">Discussion about F1</h2>
        </div>
    </header>

  <div class="p-10">
    <div class="flex gap-4 items-center mb-6">
      <div class="flex flex-wrap items-center gap-4 mb-6">
    <!-- Search input -->
    <input id="search-input" type="search" placeholder="Search discussion..." class="p-2 text-black rounded-md flex-grow min-w-[200px]" />
    <button id="search-btn" class="px-4 py-2 bg-red-700 hover:bg-red-900 rounded-md">Search</button>

    <!-- Filter -->
    <div class="flex items-center gap-4 ml-auto px-10">
      <p>Filter by:</p>
      <select id="filter" class="p-2 rounded-md text-black">
        <option value="latest">Latest</option>
        <option value="oldest">Oldest</option>
        <option value="popular">Popular</option>
        <option value="hot">Hot</option>
      </select>

      <div id="pagination" class="flex gap-2 ml-10"></div>
    </div>
  </div>

      <div class="ml-auto">
        {% if user.is_authenticated %}
        <a href="{% url 'forums:create_forum' %}" class="px-4 py-2 bg-red-600 hover:bg-red-800 rounded-md font-semibold">New Discussion</a>
        {% else %}
        <a href="{% url 'authentication:login' %}?next={% url 'forums:create_forum' %}" class="px-4 py-2 bg-red-600 hover:bg-red-800 rounded-md font-semibold">Login to create</a>
        {% endif %}
      </div>
    </div>

    <div id="loading" class="hidden font-bold text-white bg-neutral-900 border border-gray-800 rounded-xl p-12 text-center">Loading...</div>
    <div id="error" class="hidden text-red-400 bg-neutral-900 border border-gray-800 rounded-xl p-12 text-center">Failed to load forums</div>
    <section id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></section>
    <section id="empty" class="hidden bg-neutral-900 border border-gray-800 rounded-xl p-12 text-center">
      <h3 class="text-2xl font-bold text-white">No discussion yet</h3>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
<script>
const API = "{% url 'forums:show_json' %}";
const grid = document.getElementById('grid');
const loading = document.getElementById('loading');
const errorEl = document.getElementById('error');
const emptyEl = document.getElementById('empty');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');

function showLoading() {
  loading.classList.remove('hidden');
  errorEl.classList.add('hidden');
  grid.classList.add('hidden');
  emptyEl.classList.add('hidden');
}
function showError() {
  errorEl.classList.remove('hidden');
  loading.classList.add('hidden');
}
function showEmpty() {
  emptyEl.classList.remove('hidden');
  loading.classList.add('hidden');
  grid.classList.add('hidden');
}
function showGrid() {
  grid.classList.remove('hidden');
  loading.classList.add('hidden');
  emptyEl.classList.add('hidden');
}

function buildCard(item) {
  const forum = document.createElement('div');
  forum.className = 'bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex flex-col p-5 w-full';
  forum.style.height = '280px';
  forum.style.boxSizing = 'border-box';

  const link = "{% url 'forums:show_forum_detail' '00000000-0000-0000-0000-000000000000' %}".replace(
    '00000000-0000-0000-0000-000000000000',
    item.id
  );

  const title = DOMPurify.sanitize(item.title);
  const content = DOMPurify.sanitize(item.content);

  forum.innerHTML = `
    <div class="flex flex-col flex-1 overflow-hidden">
      <h3 class="text-lg md:text-xl font-semibold text-gray-900 mb-1" style="
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      ">
        <a href="${link}" class="hover:text-red-700 transition-colors duration-200">${title}</a>
      </h3>

      <p class="text-sm text-gray-500 mb-3">${item.author || 'Anonymous'}</p>

      <p class="text-gray-700 text-sm mt-4" style="
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        line-height: 1.4em;
        max-height: calc(1.4em * 3);
      ">
        ${content}
      </p>
    </div>

    <div class="flex flex-wrap items-center text-xs md:text-sm text-gray-400 mt-auto space-x-2 cursor-pointer">
      <time>${new Date(item.created_at).toLocaleDateString()}</time>
      <span>•</span>
      <span>${item.forums_views} views</span>
      <span>•</span>
      <span>${item.forums_replies_counts} replies</span>
      </div>
      <a href="${link}" class="ml-auto text-red-600 hover:text-red-800 font-medium text-sm md:text-base">Read more →</a>
  `;

  return forum;
}

const filterSelect = document.getElementById('filter');
const paginationEl = document.getElementById('pagination');
let currentPage = 1;
let currentFilter = 'latest';
let lastTotalPages = 1;

async function fetchAndRender(q='', page=1, filter='latest') {
  try {
    showLoading();
    const url = new URL(API, window.location.origin);
    if (q) url.searchParams.set('q', q);
    url.searchParams.set('page', page);
    url.searchParams.set('filter', filter);
    url.searchParams.set('page_size', 9);

    const res = await fetch(url, { headers: {'Accept': 'application/json'} });
    if (!res.ok) throw new Error('fetch failed');
    const data = await res.json();

    grid.innerHTML = '';
    if (data.results.length === 0) {
      showEmpty();
      return;
    }

    data.results.forEach(item => grid.appendChild(buildCard(item)));
    showGrid();

    renderPagination(data.num_pages, page);
    lastTotalPages = data.num_pages;

  } catch (e) {
    console.error(e);
    showError();
  }
}

function renderPagination(totalPages, activePage) {
  paginationEl.innerHTML = '';

  const prevBtn = document.createElement('button');
  prevBtn.textContent = '‹';
  prevBtn.className = `px-3 py-1 rounded-md border bg-white text-black hover:bg-gray-200 ${activePage === 1 ? 'opacity-50 cursor-not-allowed' : ''}`;
  prevBtn.disabled = activePage === 1;
  prevBtn.addEventListener('click', () => {
    if (activePage > 1) fetchAndRender(searchInput.value.trim(), activePage - 1, currentFilter);
  });
  paginationEl.appendChild(prevBtn);

  createPageButton(1);

  let startPage = Math.max(2, activePage - 1);
  let endPage = Math.min(totalPages - 1, activePage + 1);

  if (startPage > 2) {
    const dots = document.createElement('span');
    dots.textContent = '…';
    dots.className = 'px-2';
    paginationEl.appendChild(dots);
  }

  for (let i = startPage; i <= endPage; i++) {
    createPageButton(i);
  }

  if (endPage < totalPages - 1) {
    const dots = document.createElement('span');
    dots.textContent = '…';
    dots.className = 'px-2';
    paginationEl.appendChild(dots);
  }

  if (totalPages > 1) createPageButton(totalPages);

  const nextBtn = document.createElement('button');
  nextBtn.textContent = '›';
  nextBtn.className = `px-3 py-1 rounded-md border bg-white text-black hover:bg-gray-200 ${activePage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}`;
  nextBtn.disabled = activePage === totalPages;
  nextBtn.addEventListener('click', () => {
    if (activePage < totalPages) fetchAndRender(searchInput.value.trim(), activePage + 1, currentFilter);
  });
  paginationEl.appendChild(nextBtn);

  function createPageButton(page) {
    const btn = document.createElement('button');
    btn.textContent = page;
    btn.className = `px-3 py-1 rounded-md border ${page === activePage ? 'bg-red-700 text-white' : 'bg-white text-black hover:bg-gray-200'}`;
    btn.addEventListener('click', () => fetchAndRender(searchInput.value.trim(), page, currentFilter));
    paginationEl.appendChild(btn);
  }
}

searchBtn.addEventListener('click', () => {
  currentPage = 1;
  fetchAndRender(searchInput.value.trim(), currentPage, currentFilter);
});
searchInput.addEventListener('keydown', (e) => { 
  if (e.key === 'Enter') {
    currentPage = 1;
    fetchAndRender(searchInput.value.trim(), currentPage, currentFilter);
  }
});

filterSelect.addEventListener('change', () => {
  currentFilter = filterSelect.value;
  currentPage = 1;
  fetchAndRender(searchInput.value.trim(), currentPage, currentFilter);
});

fetchAndRender();
</script>
{% endblock content %}

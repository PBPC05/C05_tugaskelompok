{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Edit Article - PitTalk</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-gradient-to-b from-red-700 via-red-900 to-black min-h-screen py-20">
    <div class="max-w-3xl mx-auto">
        <div class="mb-6">
            <a href="{% url 'news:show_main' %}" class="text-white hover:text-gray-500 font-medium transition-colors">
                ‚Üê Back to News
            </a>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 divide-y-4">
            <!-- Header -->
            <div class="mb-8 text-center">
                <h1 class="text-2xl font-bold mb-2">Edit Article</h1>
                <p class="text-lg text-gray-700 font-semibold">Change information about your published article</p>
            </div>

            <!-- Form -->
            <form id="editForm" method="post" class="space-y-6">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="title" class="block text-sm font-medium text-black">Title</label>
                    <input type="text" id="title" name="title"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Enter news title" required>
                </div>
                <div class="mb-4">
                    <label for="content" class="block text-sm font-medium text-black">Content</label>
                    <textarea id="content" name="content" rows="15"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="Enter news content" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="category" name="category"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                        <option value="" selected>Choose a category</option>
                        <option value="f1">Formula 1/FIA</option>
                        <option value="championship">Championship</option>
                        <option value="team">Team</option>
                        <option value="driver">Driver</option>
                        <option value="constructor">Constructor</option>
                        <option value="race">Race</option>
                        <option value="analysis">Analysis</option>
                        <option value="history">F1 History</option>
                        <option value="fanbase">F1 Fanbase</option>
                        <option value="exclusive">Exclusive</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
                    <input type="url" id="thumbnail" name="thumbnail"
                        class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                        placeholder="https://example.com/image.jpg">
                </div>
                <div class="mb-4">
                    <div class="flex items-center">
                        <input id="is_featured" name="is_featured" type="checkbox"
                            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded">
                        <label for="is_featured" class="ml-2 text-base font-bold text-gray-900">Feature this
                            article</label>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
                        <button type="button" id="cancelButton"
                            class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center">Cancel</button>
                        <button type="submit" id="submitNews" form="editForm"
                            class="order-1 sm:order-2 flex-1 bg-red-700 text-white px-6 py-3 rounded-md font-medium hover:bg-red-900 transition-colors">Confirm Edit</button>
                    </div>
            </form>
        </div>

    </div>
</div>

<script>
    var newsId = 0;

    function populateFields(news) {
        console.log("Fields populated");

        const newsTitle = document.getElementById("title");
        const newsContent = document.getElementById("content");
        const newsCategory = document.getElementById("category");
        const newsThumbnail = document.getElementById("thumbnail");
        const newsFeatured = document.getElementById("is_featured");

        // fill fields with existing data
        newsTitle.value = news.title;
        newsContent.value = news.content;
        newsCategory.value = news.category;
        newsThumbnail.value = news.thumbnail;
        newsFeatured.checked = news.is_featured;
    }

    async function getExistingObjData(news_id) {
        console.log("Function called");

        try {
            const DETAIL_ENDPOINT = `{% url 'news:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', news_id);
            const response = await fetch(DETAIL_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (!response.ok) {
                throw new Error('Failed to fetch news detail');
            }

            newsId = news_id;
            const newsData = await response.json();
            populateFields(newsData);
        } catch (error) {
            console.error("Error loading object detail: " + error);
        }
    }

    async function editNewsEntry() {
        var fetchUrl = "{% url 'news:edit_news_ajax' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', newsId);

        const response = await fetch(fetchUrl, {
            method: "POST",
            body: new FormData(document.querySelector('#editForm')),
        })

        document.querySelector('#editForm').reset();
        document.dispatchEvent(new CustomEvent('productEdited'));

        if (response.ok) {
            window.location.href = "{% url 'news:show_main' %}";
        } else {
            console.log("News edit unsuccessful. Try again")
        }

        return false;
    }

    document.getElementById("editForm").addEventListener("submit", function(e) {
        e.preventDefault();
        editNewsEntry();
    })

    document.addEventListener("DOMContentLoaded", function() {
        getExistingObjData("{{ news_id }}");
    });
</script>
{% endblock content %}